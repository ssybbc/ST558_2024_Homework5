---
title: "ST550-homework5"
format: html
editor: visual
---

This week we are going to work on a student data, basically using exploratory data analysis to analyze the distribution of students' score and analyze the relationship between students' score and their home life. The data we are going to use are from the UCI machine learning data repository and is about secondary education in two Portugease schools. I actually searched online for the school name "Gabriel Pereira" and found it is actually in the southern area of Portugal, a city called Evora. This city comes with nice districting, neat road design, with residential and commerical in the center and northern part of the city and large factory in the south and eastern outskirts, and is facilitated by a express ring road. Another school named "Mousinho da Silveira" is seated in the mountain area that boarders Spain. The spread of city itself is linear from north to south and there is even a Castle in the city.

# Data import and modification

First I am going to import the data after downloading them. In order to read them from local using relative path, I need to confirm my current working directory. I would guess the wd should be them same with the project folder, but let's see.

```{r}
getwd ()
```

So I saved the file in the parent folder. I am going to modify the code from the source and load the data in.

```{r}
library (tidyverse)
mat<-read.table("../student/student-mat.csv",sep=";",header=TRUE) |> as.tibble()
por<-read.table("../student/student-por.csv",sep=";",header=TRUE) |> as.tibble()
mat
por
```

Next use inner_join () on the variables they used in their code. inner_join () retains the observation if and only if the "key values" are equal. So using inner_join we are essentially filtering out students that studies both math (mat) and Portuguese (por).

```{r}
matpor <- inner_join(mat, por, by = c ("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"))
head (matpor)

```

There is a warning:

```         
In inner_join(mat, por, by = c("school", "sex", "age", "address",:
Detected an unexpected many-to-many relationship between `x` and `y`. 
Row 79 of `x` matches multiple rows in `y`. 
Row 79 of `y` matches multiple rows in `x`.
```

What if we allow the "many-to-many" match?

```{r}
matpor2 <- inner_join(mat, por, by = c ("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet"), relationship = "many-to-many")
matpor2
```

We will proceed with this data set based on this method of inner_join. Now make an inner join on the data set from two schools on all variables other than G1, G2, G3, paid, and absence.

```{r}
matpor3 <- inner_join(mat, por, by = c ("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","guardian","traveltime","studytime","failures","schoolsup","famsup","activities","nursery","higher","internet","romantic","famrel","goout","Dalc","Walc","health"),relationship = "many-to-many")
matpor3
```

From the txt file that comes with the data set we know that the data set "mat" is associated with math score and the data set "por" is associated with Portuguese score. We choose four categorical variables and convert them into factor variables in each tibble. I am interested in school, mother's job, father's job and study time.

```{r}
mat2 <- mat |> mutate (schoolfct = as.factor (school),
                       Mjobfct = as.factor (Mjob),
                       Fjobfct = as.factor (Fjob),
                       studytimefct = as.factor (studytime)) |> select (-school, -Mjob, -Fjob, -studytime)
por2 <- por |> mutate (schoolfct = as.factor (school),
                       Mjobfct = as.factor (Mjob),
                       Fjobfct = as.factor (Fjob),
                       studytimefct = as.factor (studytime)) |> select (-school, -Mjob, -Fjob, -studytime)
matpor4 <- matpor3 |> mutate (schoolfct = as.factor (school),
                       Mjobfct = as.factor (Mjob),
                       Fjobfct = as.factor (Fjob),
                       studytimefct = as.factor (studytime)) |> select (-school, -Mjob, -Fjob, -studytime)

str(mat2 [,30:33])
str (por2 [,30:33])
str (matpor4 [,36:39])
```

Now we saw the new tibbles are with the four character variables transformed into factor variables.

# Summarize the data

## Categorical variables

BaseR has a good function to generate contigency table called table(). We will first use this function to generate a one-way, a two-way and a three-way contingency table.

```{r}
table(matpor4$schoolfct)
```
This one-way contingency table showed basically the number of students from each school in the combined data set. For example, there are 287 students in the GP high school.

```{r}
table (matpor4$Mjobfct, matpor4$studytimefct)
```
This two-way contingency table showed the students' weekly study time and their mom's job. For example, it showed there are 7 students whose moms work as civic servants had weekly study time more than 10 hours.

```{r}
table (matpor4$Mjobfct, matpor4$studytimefct, matpor4$Fjobfct)
```
In addition, this three-way contingency table showed the weekly study time and their mom's job, on the condition of their father's job. You could see there are 4 students whose both parents work as civic servants study more than 10 hours a week.

Next we will create a conditional two-way table using filter () function and subsetting separately.

```{r}
matpor4subset <- matpor4|> filter (Fjobfct == "health")
table (matpor4subset$Mjobfct, matpor4subset$studytimefct)
```
Above is the filter data method

```{r}
jbsttmtable <- table (matpor4$Mjobfct, matpor4$studytimefct, matpor4$Fjobfct)
jbsttmtable[,,2]
```
The above is the subsetting method.

Next we create a two-way contingency table using group_by() and summarize(). For example we could do school and study time.

```{r}
matpor4 |> group_by(schoolfct, studytimefct) |> summarize (count = n())
```

We could use the function pivot_wider() to transform the table into a table()-style like output.

```{r}
matpor4 |> group_by(schoolfct, studytimefct) |> summarize (count = n()) |> pivot_wider(names_from = schoolfct, values_from = count)
```

Lastly we will create a bar graph showed the number of students with different mothers' job. 

```{r}
ggplot (data = matpor4, aes (x = Mjobfct)) +
  geom_bar() +
  labs (x="Mother's job")
```

We then create a side-by-side bar graph showing the number of students with different study time and mother's job.

```{r}
ggplot (data = matpor4, aes (x = studytimefct, fill = Mjobfct)) +
  geom_bar(position = "dodge") +
  labs (x="Weekly study time level")
```

## Numeric variables

First we want to find the center and spread to characterize the numeric variable in the combined data set: age, absence and G3. Need to remember for the combined data set, there are two variable for G3, one for math, another one for Portuguese.


```{r}
numericsummary <- matpor4 |> 
  rename (absences_mat = absences.x, absences.por = absences.y, G3_mat = G3.x, G3_por = G3.y) |> 
  summarize (across (c(age, absences_mat, G3_mat),                                                                       .fns = list ("mean" = mean, "median" = median, "var" = var, "sd" = sd, "IQR" = IQR), 
                     .names = "{.fn}_{.col}"))
```

We could subset the data only to show the stats related with the variable "age", "absences_mat", "G3_mat"

```{r}
numericsummary [1:5]
numericsummary [6:10]
numericsummary [11:15]
```

It is better if we summarize the statistics of numeric variables according to different groups of sample students. We could grouping the numeric variables according to their Father's job.

```{r}
numericsummarygroup <- matpor4 |>
  rename (absences_mat = absences.x, absences.por = absences.y, G3_mat = G3.x, G3_por = G3.y) |> 
  group_by(Fjobfct) |>
  drop_na (Fjobfct) |>
  summarize (across (c(age, absences_mat, G3_mat), .fns = list ("mean" = mean, "median" = median), names = "{.fn}_{.col}"))
numericsummarygroup
```

From the table we could tell students whose fathers are teachers have a higher mean value for math score, and at home dads tend to have kids with less absence for math class. Now we would like to add another grouping factor: school.

```{r}
numericsummarygroup <- matpor4 |>
  rename (absences_mat = absences.x, absences.por = absences.y, G3_mat = G3.x, G3_por = G3.y) |> 
  group_by(Fjobfct, schoolfct) |>
  drop_na (Fjobfct, schoolfct) |>
  summarize (across (c(age, absences_mat, G3_mat), .fns = list ("mean" = mean, "median" = median), names = "{.fn}_{.col}"))
numericsummarygroup
```
In general students tend to have lower math score and higher absences at MS high compared with GP high for math. However, if the students have teacher fathers then there is minimal differences in their average math score, although median math score is lower at MS high. Now that we could create a correlation matrix for all the numeric variables, including age, absences, G1/G2/G3 for math and Portuguese.

```{r}
matpor4rename <- matpor4 |>
  rename (absences_mat = absences.x, absences_por = absences.y, 
          G3_mat = G3.x, G3_por = G3.y, G1_mat = G1.x, G1_por = G1.y, G2_mat = G2.x, G2_por = G2.y)
matpor4rename |> select (age, absences_mat, absences_por, G1_mat, G1_por, G2_mat, G2_por, G3_mat, G3_por) |>
  cor (method = "pearson") |> round (2)
```

In the correlation coefficient table, we could see the absences between the two classes are highly correlated, and absences are generally negatively correlated with scores. Regarding testing score, they are very highly correlated, even in different subjects. Probably the students who had higher score in one subject tend to not have a lower score in another subject as well. It would be interested to see how other variables contribute to the score of the two subjects as well.
Next we will illustrate how different values of categorical variables affect the distribution of numeric variables. Specifically in this data set, we will be looking at how weekly study time affect the distribution of final score and math and Portuguese, using kernel density plot, histogram and box plot.

First let's plot a kernel density plot and a histogram

```{r}
ggplot (matpor4rename, aes (x = G3_mat, fill = studytimefct)) +
  geom_density (alpha = 0.5) +
  xlab ("Final score for math")
```
```{r}
ggplot (matpor4rename, aes (x = G3_mat, fill = studytimefct)) +
 geom_histogram (alpha = 0.5, position = "identity", bins = 15)+
  xlab ("Final score for math")
```

Because there are very different number of students in each group of study time, so clearly density plot is a better choice. The data suggested the majority of students studying 2-5 hours weekly had a slightly lower score at Math.
Here we plot the blox plot.
```{r}
ggplot (matpor4rename, (aes (x = studytimefct, y = G3_mat, fill = studytimefct))) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.6) +
  xlab ("Time spent on study") +
  ylab ("Final score for math")
```
Following the same method, we could make plots for the Portuguese score.

```{r}
ggplot (matpor4rename, aes (x = G3_por, fill = studytimefct)) +
  geom_density (alpha = 0.5) +
  xlab ("Final score for Portuguese")
```
```{r}
ggplot (matpor4rename, aes (x = G3_por, fill = studytimefct)) +
 geom_histogram (alpha = 0.5, position = "identity", bins = 15)+
  xlab ("Final score for Portuguese")
```

```{r}
ggplot (matpor4rename, (aes (x = studytimefct, y = G3_por, fill = studytimefct))) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.6) +
  xlab ("Time spent on study") +
  ylab ("Final score for Portuguese")
```

It is clearly from the kernel density plot and the box plot that students who study 5-10 hours weekly had the highest score for Portuguese, although there seemed to be a single person who study more than 10 hours a week scored really high on Portuguese.

We further explore the relationship between the 1st period grade and the final grade on math, with different levels of study time per week.

```{r}
g <- ggplot (matpor4rename, aes (x = G1_mat, y = G3_mat, color = studytimefct)) +
  geom_point(size = 3) +
  geom_jitter(width = 0.1, alpha = 0.6, size = 3) +
  xlab ("Math first period grade") +
  ylab ("Math final grade")
```

There are a bunch of students who got zero for the final grade. Probably that is due to no show up. When exploring relations, better remove those points. In addition, there seemed to be strong relationship in each group of study time. We could add a trend line on this.

```{r}
matpor4rename1 <- matpor4rename |> filter (G3_mat > 0)
g1 <- matpor4rename1 |> ggplot (aes (x = G1_mat, y = G3_mat, color = studytimefct)) +
  geom_point(size = 3) +
  geom_jitter(width = 0.1, alpha = 0.6, size = 3) +
  xlab ("Math first period grade") +
  ylab ("Math final grade")+ 
  geom_smooth(method = lm)
g1
```

From this plot we could see the correlation between the 1st and the final math score is not changed solely by the time students spent on studying. Then how about different career choices by their fathers?

```{r}
g2 <- matpor4rename1 |> ggplot (aes (x = G1_mat, y = G3_mat)) +
  geom_point(size = 3) +
  geom_jitter(width = 0.1, alpha = 0.6, size = 3) +
  xlab ("Math first period grade") +
  ylab ("Math final grade")+ 
  geom_smooth(method = lm)
g2 + facet_wrap (~Fjobfct)
```

So the correlation between 1st and final math score is pretty strong, but having a father working in the health industry seemed to be more likely to improve your math results. Now we would like to see the effect of each combination of the two categorical variables on the relationship of 1st vs final Math test.

```{r}
g2 + facet_grid(studytimefct ~ Fjobfct) +
  ylim (c(4,24))
```

This visualization offers a broader view of both factors on score improvement. First, it looks like the length of study per week affect the 1st test score of math, espeically when the dad works for the public sector. Probably that reflects the students' study habits. Second it looks like studying for 5-10 hours per week might results in better improvement of score, especially if you have a health worker dad or a teacher dad. All in all, it is an excellent data set to explore the students' performance with their family conditions.


